
<!doctype html>
<html lang="sv">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>SIROCCO Tournament – Mobil v3.1</title>
<style>
  :root{--bg:#fff;--ink:#222;--accent:#c0392b;--muted:#eaeaea;--ok:#27ae60}
  html,body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
  header{position:sticky;top:0;background:#fff;border-bottom:1px solid var(--muted);padding:14px 16px;z-index:5}
  h1{font-size:20px;margin:0;color:var(--accent)}
  .wrap{max-width:860px;margin:0 auto;padding:12px 16px}
  .grid{display:grid;gap:12px}
  .card{background:#fff;border:1px solid var(--muted);border-radius:12px;box-shadow:0 2px 6px rgba(0,0,0,.04)}
  .card h2{margin:0;padding:12px 14px;border-bottom:1px solid var(--muted);font-size:16px}
  .card .body{padding:12px 14px}
  .row{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
  .teams{font-weight:600}
  .match{padding:10px 0;border-top:1px dashed #eee}
  .match:first-child{border-top:none}
  input[type=text]{flex:0 0 120px;padding:10px;border:1px solid #d0d0d0;border-radius:8px;font-size:16px}
  .note{font-size:12px;color:#666}
  table{width:100%;border-collapse:collapse;font-size:14px}
  th,td{padding:8px;border-bottom:1px solid #eee;text-align:left}
  .rank{text-align:right;font-variant-numeric:tabular-nums}
  .pill{display:inline-block;padding:4px 10px;border-radius:999px;border:1px solid #ddd;background:#fafafa;font-size:12px}
  .ok{color:var(--ok)}
  .actions{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
  .btn{appearance:none;border:1px solid var(--accent);background:var(--accent);color:#fff;border-radius:10px;padding:10px 12px;font-weight:600;cursor:pointer}
  .btn.secondary{background:#fff;color:var(--accent)}
</style>
</head>
<body>
<header>
  <h1>SIROCCO v3.1 – Mobil</h1>
  <div class="note">Nu uppdelat i <b>7 omgångar</b> – varje omgång består av <b>2 matcher</b> där alla 8 spelar.</div>
</header>
<main class="wrap grid">
  <section class="card">
    <h2>Schema per omgång</h2>
    <div class="body">
      <label for="roundSel" class="note">Välj omgång</label>
      <select id="roundSel"></select>
      <div id="roundBox" style="margin-top:10px"></div>
      <div class="actions">
        <button class="btn" id="saveBtn">Spara lokalt</button>
        <button class="btn secondary" id="loadBtn">Ladda sparat</button>
        <button class="btn secondary" id="clearBtn">Nollställ allt</button>
      </div>
    </div>
  </section>

  <section class="card">
    <h2>Tabell</h2>
    <div class="body">
      <div id="status" class="note">Grundserie pågår…</div>
      <table>
        <thead><tr><th>Spelare</th><th class="rank">Spelade</th><th class="rank">Poäng</th><th class="rank">Gem +/-</th></tr></thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>
  </section>

  <section class="card">
    <h2>Slutspel</h2>
    <div class="body" id="playoff"><div class="note">Visas när alla 14 matcher har resultat.</div></div>
  </section>
</main>

<script>
const players = {"0": "Kristofer Winge", "1": "Henrik Nyiri", "2": "Emil Svensson", "3": "Henrik Winskogh", "4": "Robert Norberg", "5": "Sasha Koterac", "6": "Håkan Norberg", "7": "Magnus Bengtsson"}; // id->name
const rounds = [[[[0, 1], [2, 3]], [[4, 5], [6, 7]]], [[[0, 2], [1, 3]], [[4, 6], [5, 7]]], [[[0, 3], [1, 2]], [[4, 7], [5, 6]]], [[[0, 4], [1, 5]], [[2, 6], [3, 7]]], [[[0, 5], [1, 4]], [[2, 7], [3, 6]]], [[[0, 6], [1, 7]], [[2, 4], [3, 5]]], [[[0, 7], [1, 6]], [[2, 5], [3, 4]]]];   // 7 omgångar × 2 matcher × 2 spelare/lag
const results = JSON.parse(localStorage.getItem('sirocco_v31_results')||'{}');

const matchKey = (r,i)=>`r${r+1}_m${i+1}`; // r=0..6, i=0..1
function teamLabel(ids){ return ids.map(id=>players[id]).join(' + '); }
function parseScore(s){ if(!s) return null; const p=s.replace(/\s+/g,'').split('-'); if(p.length!==2) return null; const a=parseInt(p[0],10), b=parseInt(p[1],10); if(Number.isNaN(a)||Number.isNaN(b)) return null; return [a,b]; }

function renderRound(r){
  const wrap=document.getElementById('roundBox'); wrap.innerHTML='';
  rounds[r].forEach((match,i)=>{
    const [t1,t2]=match; const val=results[matchKey(r,i)]||'';
    const div=document.createElement('div'); div.className='match';
    div.innerHTML = `<div class='teams'>Match ${i+1}: ${teamLabel(t1)} <span class='note'>vs</span> ${teamLabel(t2)}</div>
      <div class='row'><input type='text' placeholder='ex. 21-18' value='${val}' data-r='${r}' data-i='${i}'></div>`;
    wrap.appendChild(div);
  });
}

function emptyStats(){ const s={}; Object.keys(players).forEach(id=>s[id]={played:0,p:0,gd:0}); return s; }

function compute(){
  const stats=emptyStats();
  rounds.forEach((rm,r)=>{
    rm.forEach((match,i)=>{
      const s=parseScore(results[matchKey(r,i)]||''); if(!s) return; const [a,b]=s; const [t1,t2]=match; const diff=a-b; let p1=0,p2=0; if(a>b){p1=2;} else if(a<b){p2=2;} else {p1=1;p2=1;}
      t1.concat(t2).forEach(id=>stats[id].played++);
      t1.forEach(id=>{ stats[id].p+=p1; stats[id].gd+=diff; });
      t2.forEach(id=>{ stats[id].p+=p2; stats[id].gd-=diff; });
    });
  });
  const rows=Object.keys(players).map(id=>({id,name:players[id],...stats[id]}));
  rows.sort((a,b)=> b.p - a.p || b.gd - a.gd || a.name.localeCompare(b.name));
  const allValid = rounds.every((rm,r)=> rm.every((_,i)=> parseScore(results[matchKey(r,i)]||'')));
  return {rows, allValid};
}

function renderTable(){
  const {rows, allValid}=compute();
  const tb=document.getElementById('tbody'); tb.innerHTML='';
  rows.forEach(r=>{ const tr=document.createElement('tr'); tr.innerHTML = `<td>${r.name}</td><td class='rank'>${r.played}</td><td class='rank'>${r.p}</td><td class='rank'>${r.gd>0?'+':''}${r.gd}</td>`; tb.appendChild(tr); });
  document.getElementById('status').innerHTML = allValid? `<span class='pill ok'>Grundserie klar</span>` : `<span class='pill'>Grundserie pågår…</span>`;
  return allValid? rows : null;
}

function renderPlayoff(){
  const box=document.getElementById('playoff');
  const rows=renderTable();
  if(!rows){ box.innerHTML = `<div class='note'>Visas när alla 14 matcher har resultat.</div>`; return; }
  const ids=rows.map(r=>r.id);
  const A={t1:[ids[0],ids[1]], t2:[ids[2],ids[3]]};
  const B={t1:[ids[4],ids[5]], t2:[ids[6],ids[7]]};
  box.innerHTML = `<div class='match'><div class='teams'>Slutspel A: ${A.t1.map(id=>players[id]).join(' + ')} <span class='note'>vs</span> ${A.t2.map(id=>players[id]).join(' + ')}</div></div>
                   <div class='match'><div class='teams'>Slutspel B: ${B.t1.map(id=>players[id]).join(' + ')} <span class='note'>vs</span> ${B.t2.map(id=>players[id]).join(' + ')}</div></div>`;
}

function save(){ localStorage.setItem('sirocco_v31_results', JSON.stringify(results)); }
function load(){ const obj=JSON.parse(localStorage.getItem('sirocco_v31_results')||'{}'); Object.assign(results,obj); }
function clearAll(){ localStorage.removeItem('sirocco_v31_results'); for(const k in results) delete results[k]; }

function boot(){
  // round selector
  const sel=document.getElementById('roundSel');
  for(let i=0;i<rounds.length;i++){ const opt=document.createElement('option'); opt.value=i; opt.textContent=`Omgång ${i+1}`; sel.appendChild(opt); }
  sel.value=0; sel.addEventListener('change', ()=>{ renderRound(parseInt(sel.value,10)); });

  // first render
  renderRound(0); renderTable(); renderPlayoff();

  // input handling
  document.getElementById('roundBox').addEventListener('input', (e)=>{
    if(e.target && e.target.dataset){
      const r=parseInt(e.target.dataset.r,10), i=parseInt(e.target.dataset.i,10);
      results[matchKey(r,i)] = e.target.value; save(); renderTable(); renderPlayoff();
    }
  });

  // buttons
  document.getElementById('saveBtn').onclick=()=>{ save(); alert('Sparat lokalt på denna enhet.'); };
  document.getElementById('loadBtn').onclick=()=>{ load(); renderRound(parseInt(sel.value,10)); renderTable(); renderPlayoff(); };
  document.getElementById('clearBtn').onclick=()=>{ if(confirm('Nollställ alla resultat i denna enhet?')){ clearAll(); renderRound(parseInt(sel.value,10)); renderTable(); renderPlayoff(); } };
}

boot();
</script>
</body>
</html>
